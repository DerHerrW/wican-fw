<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>WiCAN</title>
	<style>
	body {
		font-family: Arial;
	}
	
	.tab {
		overflow: hidden;
		border: 1px solid #24478f;
		background-color: #c2d1f0;
		width: 100%;
	}
	
	.tab button {
		background-color: inherit;
		float: left;
		border: none;
		outline: none;
		cursor: pointer;
		padding: 14px 16px;
		transition: 0.3s;
		font-size: 17px;
	}
	
	.tab button:hover {
		background-color: #ddd;
	}
	
	.tab button.active {
		background-color: #24478f;
		color: white;
	}
	
	.tabcontent {
		display: none;
		padding: 6px 12px;
		border: 1px solid #24478f;
		border-top: none;
	}
	
	table,
	th,
	td {
		border-collapse: collapse;
		border-spacing: 0;
		text-align: left;
		padding: 8px;
	}
	
	#table1 {
		width: 350px;
		text-align: left;
		padding: 8px;
	}
	
	#table2 {
		width: 350px;
		text-align: left;
		max-width: 350;
		font-size: 70%;
		white-space: nowrap;
	}
	
	#table3 {
		width: 350px;
		text-align: left;
		max-width: 350;
		font-size: 80%;
		border: 1px solid;
		white-space: nowrap;
	}
	</style>
</head>

<body onload="Load()">
	<embed src="/logo.svg" style="width: 165px; height: 66px; display: block;" />
	<div class="tab">
		<button class="tablinks" onclick="openTab(event, 'status_view')" id="defaultOpen"><b>Status</b></button>
		<button class="tablinks" onclick="openTab(event, 'wifi_settings')"><b>Settings</b></button>
        <button class="tablinks" onclick="openTab(event, 'automate')"><b>Automate</b></button>
		<button class="tablinks" onclick="openTab(event, 'monitor')"><b>Monitor</b></button>
		<button class="tablinks" onclick="openTab(event, 'about_tab')"><b>About</b></button>
	</div>
	<div id="status_view" class="tabcontent">
		<table>
			<tr>
				<td><b>WiFi Mode:</b></td>
				<td>
					<div id="wifi_mode_current">AP&nbsp;</div>
				</td>
			</tr>
			<tr>
				<td><b>AP Channel:</b></td>
				<td>
					<div id="ap_channel_status">6&nbsp;</div>
				</td>
			</tr>
			<tr>
				<td><b>WiFi Station:</b></td>
				<td>
					<div id="sta_status">Not Connected&nbsp;</div>
				</td>
			</tr>
			<tr>
				<td><b>Station IP:</b></td>
				<td>
					<div id="sta_ip">192.168.3.1&nbsp;</div>
				</td>
			</tr>
			<tr>
				<td><b>CAN Bitrate:</b></td>
				<td>
					<div id="can_bitrate_status">500K&nbsp;</div>
				</td>
			</tr>
			<tr>
				<td><b>CAN Mode:</b></td>
				<td>
					<div id="can_mode_status">Silent&nbsp;</div>
				</td>
			</tr>
			<tr>
				<td><b>Port Type:</b></td>
				<td>
					<div id="port_type_status">TCP&nbsp;</div>
				</td>
			</tr>
			<tr>
				<td><b>TCP/UDP Port:</b></td>
				<td>
					<div id="port_status">3333&nbsp;</div>
				</td>
			</tr>
			<tr>
				<td><b>Battery Voltage:</b></td>
				<td>
					<div id="batt_voltage">12.8V&nbsp;</div>
				</td>
			</tr>
			<tr>
				<td>
					<input id="check_status_button" name="check_status_button" type="button" onclick="checkStatus()" value="Check status" />
				</td>
				<td>&nbsp;</td>
			</tr>
		</table>
	</div>
	<form id="configForm" name="configForm" action="/action_page" onchange="submit_enable();" onfocus="this.selectedIndex = -1;">
		<div id="wifi_settings" class="tabcontent">
			<table>
				<tr>
					<td> <b> <u>AP Config:</u> </b> </td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td>
						<label for="wifi_mode"> <b>Mode:</b> </label>
					</td>
					<td>
						<select name="wifi_mode" style="width: 93px;" id="wifi_mode">
							<option value="AP">Ap</option>
							<option value="APStation">AP+Station</option>
						</select>
					</td>
				</tr>
				<tr>
					<td><b>AP Channel:</b></td>
					<td>
						<select name="ap_ch_value" style="width: 93px;" id="ap_ch_value">
							<option value="1">1</option>
							<option value="2">2</option>
							<option value="3">3</option>
							<option value="4">4</option>
							<option value="5">5</option>
							<option value="6">6</option>
							<option value="7">7</option>
							<option value="8">8</option>
							<option value="9">9</option>
							<option value="10">10</option>
							<option value="11">11</option>
							<option value="12">12</option>
							<option value="13">13</option>
							<option value="14">14</option>
						</select>
					</td>
				</tr>
				<tr>
					<td>
						<label for="ap_pass_value"> <b>AP Password:</b> </label>
					</td>
					<td>
						<input type="text" id="ap_pass_value" name="ap_pass_value" value="Testpass" />
					</td>
				</tr>
				<tr>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td> <b> <u>Station Config:</u> </b> </td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td>
						<label for="ssid_value"> <b>SSID:</b> </label>
					</td>
					<td>
						<input type="text" id="ssid_value" name="ssid_value" value="MeatPi" disabled />
					</td>
				</tr>
				<tr>
					<td>
						<label for="pass_value"> <b>Password:</b> </label>
					</td>
					<td>
						<input type="text" id="pass_value" name="pass_value" value="TomatoSauce" disabled />
					</td>
				</tr>
				<tr>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td> <b> <u>CAN:</u> </b> </td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td>
						<label for="can_datarate"> <b>CAN Bitrate:</b> </label>
					</td>
					<td>
						<select name="can_datarate" style="width: 93px;" id="can_datarate">
							<option value="5K">5K</option>
							<option value="10K">10K</option>
							<option value="20K">20K</option>
							<option value="25K">25K</option>
							<option value="50K">50K</option>
							<option value="100K">100K</option>
							<option value="125K">125K</option>
							<option value="250K">250K</option>
							<option value="500K">500K</option>
							<option value="800K">800K</option>
							<option value="1000K">1000K</option>
							<option value="auto">Auto</option>
						</select>
					</td>
				</tr>
				<tr>
					<td>
						<label for="can_mode"> <b>CAN Mode:</b> </label>
					</td>
					<td>
						<select name="can_mode" style="width: 93px;" id="can_mode">
							<option value="normal" selected="selected">Normal</option>
							<option value="silent">Silent</option>
						</select>
					</td>
				</tr>
				<tr>
					<td>
						<label for="port_type"> <b>Port Type:</b> </label>
					</td>
					<td>
						<select name="port_type" style="width: 93px;" id="port_type">
							<option value="tcp">TCP</option>
							<option value="udp">UDP</option>
						</select>
					</td>
				</tr>
				<tr>
					<td>
						<label for="tcp_port_value"> <b>TCP/UDP Port:</b> </label>
					</td>
					<td>
						<input type="number" id="tcp_port_value" name="tcp_port_value" value="3333" min="1" max="65535" />
					</td>
				</tr>
				<tr>
					<td>
						<label for="protocol"> <b>Protocol:</b> </label>
					</td>
					<td>
						<select name="protocol" style="width: 93px;" id="protocol">
							<option value="realdash66">realdash66</option>
							<option value="slcan">slcan</option>
							<option value="savvycan">savvyCAN</option>
							<option value="elm327">elm327</option>
                            <option value="auto_pid">AutoPID</option>
						</select>
					</td>
				</tr>
				<tr>
					<td>
						<label for="mqtt_en"> <b>MQTT:</b> </label>
					</td>
					<td>
						<select name="mqtt_en" style="width: 93px;" id="mqtt_en">
							<option value="enable">Enable</option>
							<option value="disable">Disable</option>
						</select>
					</td>
				</tr>
				<tr>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td> <b> <u>BLE:</u> </b> </td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td>
						<label for="ble_pass_value"> <b>Passkey:</b> </label>
					</td>
					<td>
						<input type="number" id="ble_pass_value" name="ble_pass_value" value="000000" min="0" max="999999" />
					</td>
				</tr>
				<tr>
					<td>
						<label for="ble_status"> <b>BLE Status:</b> </label>
					</td>
					<td>
						<select name="ble_status" style="width: 93px;" id="ble_status">
							<option value="enable">Enable</option>
							<option value="disable">Disable</option>
						</select>
					</td>
				</tr>
				<tr>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td> <b> <u>Sleep Mode:</u> </b> </td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td>
						<label for="sleep_status"> <b>Sleep:</b> </label>
					</td>
					<td>
						<select name="sleep_status" style="width: 93px;" id="sleep_status">
							<option value="enable">Enable</option>
							<option value="disable">Disable</option>
						</select>
					</td>
				</tr>
				<tr>
					<td><b>Sleep Voltage:</b></td>
					<td>
						<input type="number" step="0.1" id="sleep_volt" name="sleep_volt" value="13.2" min="12.0" max="15.0" />
					</td>
				</tr>
				<tr>
					<td>
						<label for="batt_alert"> <b>Battery Alert:</b> </label>
					</td>
					<td>
						<select name="batt_alert" style="width: 93px;" id="batt_alert">
							<option value="enable">Enable</option>
							<option value="disable">Disable</option>
						</select>
					</td>
				</tr>
				<tr>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
				</tr>
			</table>
			<div id="mqtt_en_div">
				<table>
					<tr>
						<td> <b> <u>MQTT:</u> </b> </td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td>
							<label for="mqtt_url"> <b>MQTT URL:</b> </label>
						</td>
						<td>
							<input type="text" id="mqtt_url" name="mqtt_url" value="127.0.0.1" />
						</td>
					</tr>
					<tr>
						<td>
							<label for="mqtt_port"> <b>MQTT Port:</b> </label>
						</td>
						<td>
							<input type="number" id="mqtt_port" name="mqtt_port" value="1883" min="1" max="65535" />
						</td>
					</tr>
					<tr>
						<td>
							<label for="mqtt_user"> <b>MQTT User:</b> </label>
						</td>
						<td>
							<input type="text" id="mqtt_user" name="mqtt_user" value="meatpi" />
						</td>
					</tr>
					<tr>
						<td>
							<label for="mqtt_pass"> <b>MQTT Pass:</b> </label>
						</td>
						<td>
							<input type="text" id="mqtt_pass" name="mqtt_pass" value="meatpi" />
						</td>
					</tr>
					<tr>
						<td>
							<label for="mqtt_tx_topic"> <b>TX Topic:</b> </label>
						</td>
						<td>
							<input type="text" id="mqtt_tx_topic" name="mqtt_tx_topic" value="" />
						</td>
						<td><input type="checkbox" id="mqtt_tx_en_checkbox" name="mqtt_tx_en_checkbox" onchange="txCheckBoxChanged()"></td>
					</tr>
					<tr>
						<td>
							<label for="mqtt_rx_topic"> <b>RX Topic:</b> </label>
						</td>
						<td>
							<input type="text" id="mqtt_rx_topic" name="mqtt_rx_topic" value="" />
						</td>
					</tr>
					<tr>
						<td>
							<label for="mqtt_status_topic"> <b>Status Topic:</b> </label>
						</td>
						<td>
							<input type="text" id="mqtt_status_topic" name="mqtt_status_topic" value="" />
						</td>
					</tr>
					<tr>
						<td>
							<label for="mqtt_elm327_log"> <b>MQTT elm327 log:</b> </label>
						</td>
						<td>
							<select name="mqtt_elm327_log" style="width: 93px;" id="mqtt_elm327_log" onchange="alert_elm327()">
								<option value="enable">Enable</option>
								<option value="disable">Disable</option>
							</select>
						</td>
					</tr>
					<tr>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
				</table>
                <div style="overflow-x:auto;">
				<table id="can_flt_table">
					<tr>
						<th>CAN ID (dec)</th>
						<th>Name</th>
						<th>PID</th>
						<th>Index</th>
						<th>Start Bit</th>
						<th>Bit Length</th>
						<th>Expression</th>
						<th>Cycle ms</th>
						<th>
							<input id="store_canflt_button" name="store_canflt_button" type="button" onclick="storeCANFLT()" value="Store" style="width: 70px;" />
						</th>
					</tr>
					<tr>
						<td>
							<input type="number" id="canId" min="0" max="536870912" style="width: 100px;" />
						</td>
						<td>
							<input type="text" id="name" maxlength="16" style="width: 70px;" />
						</td>
						<td>
							<input type="number" id="pid" style="width: 40px;" />
						</td>
						<td>
							<input type="number" id="pindex" style="width: 40px;" />
						</td>
						<td>
							<input type="number" id="startBit" min="0" max="63" style="width: 40px;" />
						</td>
						<td>
							<input type="number" id="bitLength" min="1" max="64" style="width: 40px;" />
						</td>
						<td>
							<input type="text" id="expression" maxlength="32" style="width: 100px;" />
						</td>
						<td>
							<input type="number" id="cycle" min="100" max="1000" style="width: 50px;" />
						</td>
						<td>
							<input id="add_row_button" name="add_row_button" type="button" onclick="addCANFLTRow()" value="Add ID" style="width: 70px;" />
						</td>
					</tr>
				</table>
                </div>
			</div>
			<div id="batt_alert_div">
				<table>
					<tr>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td> <b> <u>Battery Alert:</u> </b> </td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td>
							<label for="batt_alert_ssid"> <b>SSID:</b> </label>
						</td>
						<td>
							<input type="text" id="batt_alert_ssid" name="batt_alert_ssid" value="MeatPi" />
						</td>
					</tr>
					<tr>
						<td>
							<label for="batt_alert_pass"> <b>Password:</b> </label>
						</td>
						<td>
							<input type="text" id="batt_alert_pass" name="batt_alert_pass" value="TomatoSauce" />
						</td>
					</tr>
					<tr>
						<td>
							<label for="batt_alert_volt"> <b>Alert Voltage:</b> </label>
						</td>
						<td>
							<input type="number" step="0.1" id="batt_alert_volt" name="batt_alert_volt" value="11.0" min="9.0" max="15.0" />
						</td>
					</tr>
					<tr>
						<td>
							<label for="batt_alert_protocol"> <b>Alert Protocol:</b> </label>
						</td>
						<td>
							<select name="batt_alert_protocol" style="width: 93px;" id="batt_alert_protocol">
								<option value="mqtt">MQTT</option>
							</select>
						</td>
					</tr>
					<tr>
						<td>
							<label for="batt_alert_url"> <b>Alert URL:</b> </label>
						</td>
						<td>
							<input type="text" id="batt_alert_url" name="batt_alert_url" value="127.0.0.1" />
						</td>
					</tr>
					<tr>
						<td>
							<label for="batt_alert_port"> <b>Alert Port:</b> </label>
						</td>
						<td>
							<input type="number" id="batt_alert_port" name="batt_alert_port" value="1883" min="1" max="65535" />
						</td>
					</tr>
					<tr>
						<td>
							<label for="batt_mqttusername"> <b>Alert MQTT User:</b> </label>
						</td>
						<td>
							<input type="text" id="batt_mqtt_user" name="batt_mqtt_user" value="meatpi" />
						</td>
					</tr>
					<tr>
						<td>
							<label for="batt_mqttpass"> <b>Alert MQTT Pass:</b> </label>
						</td>
						<td>
							<input type="text" id="batt_mqtt_pass" name="batt_mqtt_pass" value="meatpi" />
						</td>
					</tr>
					<tr>
						<td>
							<label for="batt_alert_topic"> <b>Alert Topic:</b> </label>
						</td>
						<td>
							<input type="text" id="batt_alert_topic" name="batt_alert_topic" value="CAR1/voltage" />
						</td>
					</tr>
					<tr>
						<td><b>Alert every:</b></td>
						<td>
							<select name="batt_alert_time" style="width: 93px;" id="batt_alert_time">
								<option value="1">1hr</option>
								<option value="6">6hr</option>
								<option value="12">12hr</option>
								<option value="24">1day</option>
							</select>
						</td>
					</tr>
					<tr>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
				</table>
			</div>
			<div id="note"> <u> <b>Note:</b> If you forget the AP password, connect usb cable to recover </u> </div>
		</div>
	</form>
    <div style="overflow-x:auto;" id="automate" class="tabcontent">

		<table>
			<tr>
				<td><label for="car_specific"><strong>Vehicle Specific:</strong></label></td>
				<td>		<select id="car_specific" name="car_specific" onchange="toggleCarModel(); toggleDestinationAndCycle(); enableAutoStoreButton();">
					<option value="enable">Enable</option>
					<option value="disable">Disable</option>
					
				</select></td>
			</tr>
			<tr>
				<td><label for="car_model"><strong>Vehicle Model:</strong></label></td>
				
				<td><select id="car_model" name="car_model" onchange="enableAutoStoreButton()">
				</select></td>
			</tr>
			<tr>
				<td><label for="ha_discovery"><strong>Home Assistant Discovery:</strong></label></td>
				<td>		<select id="ha_discovery" name="ha_discovery" onchange="checkForDuplicates(); toggleDestinationAndCycle(); toggleSendToFields(); enableAutoStoreButton();">
					<option value="disable">Disable</option>
					<!-- <option value="enable">Enable</option> -->
				</select></td>
			</tr>
			<tr>
				<td><label for="grouping"><strong>Grouping:</strong></label></td>
				<td>		<select id="grouping" name="grouping" onchange="checkForDuplicates(); toggleDestinationAndCycle(); toggleSendToFields(); enableAutoStoreButton();">
					<option value="disable">Disable</option>
					<!-- <option value="group_pid">Group PID</option>
					<option value="group_all">Group ALL</option> -->
					<!-- not yet supported -->
				</select></td>
			</tr>
			<tr>
				<td><label for="destination"><strong>Destination Topic:</strong> </label</td>
				<td><input type="text" id="destination" name="destination" disabled oninput="enableAutoStoreButton()"></td>
			</tr>
			<tr>
				<td><label for="pid_cycle"><strong>Cycle Time(ms):</strong> </label></td>
				<td><input type="text" id="pid_cycle" name="pid_cycle" disabled oninput="enableAutoStoreButton()"></td>
			</tr>
			<tr>
				<td><label for="vehicle_profiles"><strong>Vehicle Profiles:</strong> </label></td>
				<td>
					<form id="car_data_form" enctype="multipart/form-data">
						<input id="car_data_file" name="car_data_file" type="file" onchange="sendCARDataFile()" />
					</form>
				</td>
			</tr>
			<tr>
				<td><button class="store" onclick="storeAutoTableData()" disabled>Store</button></td> 
			</tr>
		</table>
		<br>
		<h2>Custom PIDs:</h2>
        <br>
        <label for="initialisation"><strong>Custom Initialisation:</strong> </label>
        <input type="text" style="width: 100%;" id="initialisation" name="initialisation" oninput="enableAutoStoreButton()">
        <br><br>
		<table id="automate_table" >
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Init</th>
                    <th>PID</th>
                    <th>Expression</th>
                    <th>Period(ms)</th>
                    <th>Type</th>
                    <th>Send_to</th>
                    <th><button class="add" onclick="addRowAutoTable()">New</button></th>
                </tr>
            </thead>
            <tbody>
            </tbody>
		</table>
	</div>
	<div id="monitor" class="tabcontent">
		<table id="table3">
			<tr>
				<td><b>Bitrate</b></td>
				<td><b>Filter</b></td>
				<td><b>Mask</b></td>
				<td>&nbsp;</td>
				<td>&nbsp;</td>
				<td>&nbsp;</td>
				<td>&nbsp;</td>
				<td>&nbsp;</td>
			</tr>
			<tr>
				<td>
					<select name="mon_datarate" id="mon_datarate" style="font-size: 100%;">
						<option value="10K">10K</option>
						<option value="20K">20K</option>
						<option value="50K">50K</option>
						<option value="100K">100K</option>
						<option value="125K">125K</option>
						<option value="250K">250K</option>
						<option value="500K" selected="selected">500K</option>
						<option value="800K">800K</option>
						<option value="1000K">1Mbit</option>
					</select>
				</td>
				<td>
					<input type="text" id="mon_filter" name="mon_filter" style="width: 65px; font-size: 100%;" value="00000000" />
				</td>
				<td>
					<input type="text" id="mon_mask" name="mon_mask" style="width: 65px; font-size: 100%;" value="FFFFFFFF" />
				</td>
				<td>&nbsp;</td>
				<td>
					<input id="mon_button" name="mon_button" type="button" onclick="mon_control()" value="Start" style="font-size: 100%;" />
				</td>
				<td>&nbsp;</td>
				<td>&nbsp;</td>
				<td>&nbsp;</td>
			</tr>
		</table>
		<table id="table2">
			<tr>
				<td><b>ID</b></td>
				<td><b>Type</b></td>
				<td><b>Len</b></td>
				<td style="width: 80%;"><b>Data</b></td>
				<td><b>Time</b></td>
				<td><b>Count</b></td>
			</tr>
		</table>
	</div>
	<div id="about_tab" class="tabcontent">
		<form id="ota_form" action="/upload/ota.bin" method="post" enctype="multipart/form-data">
			<table>
				<tr>
					<td><b>Firmware ver:</b></td>
					<td>
						<div id="fw_version">1.00</div>
					</td>
				</tr>
				<tr>
					<td><b>Hardware ver:</b></td>
					<td>
						<div id="hw_version">v2.10</div>
					</td>
				</tr>
				<tr>
					<td><b>Git ver:</b></td>
					<td>
						<div id="git_version">v2.10</div>
					</td>
				</tr>
				<tr>
					<td><b>Designed By:</b></td>
					<td>
						<div id="made_by">
							<a href="https://www.meatpi.com/"> <b>meatpi.com</b> </a>
						</div>
					</td>
				</tr>
				<tr>
					<td>
						<input id="ota_file" name="ota_file" type="file" />
					</td>
					<td>
						<input id="ota_submit_button" type="button" value="Update" onclick="otaClick()" />
					</td>
				</tr>
				<tr>
					<td>
						<input id="reboot_button" name="reboot_button" type="button" onclick="reboot()" value="Reboot" style="font-size: 100%;" />
					</td>
				</tr>
			</table>
		</form>
	</div>
	<div id="ret_msg">&nbsp;</div>
	<input id="submit_button" name="submit_button" type="button" onclick="postConfig()" value="Submit Changes" disabled />
	<script>
        // const initialData  = `{
        //     "pids": [
        //         {"Name": "John Doe", "Init": "123", "PID": "456", "Expression": "exp1", "Period": "10", "Type": "A", "Send_to": "X"},
        //         {"Name": "Jane Doe", "Init": "789", "PID": "012", "Expression": "exp2", "Period": "20", "Type": "B", "Send_to": "Y"}
        //     ]
        // }`;
        // const carModelsData = {
        //     "supported": [
        //         "hyundai",
        //         "byd",
        //         "toyota"
        //     ]
        // };
        document.addEventListener('DOMContentLoaded', (event) => {
            // loadAutoTable(initialData);
			// loadCarModels(carModelsData);
        });

        function loadCarModels(data) {
            const carModelSelect = document.getElementById("car_model");

            if (data && Array.isArray(data.supported)) {
                data.supported.forEach(model => {
                    const option = document.createElement("option");
                    option.value = model;
                    option.text = model;
                    carModelSelect.appendChild(option);
                });
            } else {
                console.error("Invalid data format or missing 'supported' property.");
            }
			toggleCarModel();
			toggleDestinationAndCycle();
			toggleSendToFields();
        }

        function toggleCarModel() {
            const carSpecific = document.getElementById("car_specific").value;
            const carModelSelect = document.getElementById("car_model");
            if (carSpecific === "disable") {
                carModelSelect.disabled = true;
                carModelSelect.value = "unspecified";
            } else {
                carModelSelect.disabled = false;
            }
			toggleDiscovery();
        }

        function toggleDestinationAndCycle() {
			const carSpecific = document.getElementById("car_specific").value;
			const grouping = document.getElementById("grouping").value;
			const destinationField = document.getElementById("destination");
			const cycleField = document.getElementById("pid_cycle");
			
			if (carSpecific === "enable" || grouping === "Group ALL") {
				destinationField.disabled = false;
				cycleField.disabled = false;
			} else {
				destinationField.disabled = true;
				cycleField.disabled = true;
			}
        }
		
		function toggleDiscovery() {
			const carSpecific = document.getElementById("car_specific").value;
			const discovery = document.getElementById("ha_discovery");

			discovery.disabled = true;
			discovery.value = "disable";
		}
		
        function txCheckBoxChanged() {
            if (document.getElementById("mqtt_tx_en_checkbox").checked) {
                document.getElementById("mqtt_tx_topic").disabled = false;
            } else {
                document.getElementById("mqtt_tx_topic").disabled = true;
            }
        }
		
		function sendCARDataFile() {
			const fileInput = document.getElementById("car_data_file");
			const maxFileSize = 200 * 1024; // 200KB in bytes

			if (fileInput.files.length == 0) {
				document.getElementById("ret_msg").style.color = "red";
				document.getElementById("ret_msg").innerHTML = "No files selected!";
				alert("No files selected!");
			} else {
				const file = fileInput.files[0];

				if (file.size > maxFileSize) {
					document.getElementById("ret_msg").style.color = "red";
					document.getElementById("ret_msg").innerHTML = "File size exceeds 200KB!";
					alert("File size exceeds 200KB!");
					return;
				}

				const reader = new FileReader();
				reader.onload = function(event) {
					try {
						JSON.parse(event.target.result);
						// If parsing is successful, proceed with the upload
						const form = document.getElementById('car_data_form');
						const formData = new FormData(form);
						document.getElementById("ret_msg").innerHTML = "";

						fetch('/upload/car_data.json', {
							method: 'POST',
							body: formData
						})
						.then(response => response.text())
						.then(data => {
							console.log('Success:', data);
							document.getElementById("ret_msg").style.color = "red";
							document.getElementById("ret_msg").innerHTML = data;
							// Delay the page refresh by 2 seconds
							setTimeout(() => {
								window.location.reload();
							}, 2000); // 2000 milliseconds = 2 seconds
						})
						.catch(error => {
							console.error('Error:', error);
						});
					} catch (e) {
						document.getElementById("ret_msg").style.color = "red";
						document.getElementById("ret_msg").innerHTML = "Invalid JSON file!";
						alert("The selected file is not a valid JSON file!");
					}
				};

				// Read the file as text
				reader.readAsText(file);
			}
		}

        function loadAutoTable(jsonData) {
            const data = JSON.parse(jsonData);
			const initialisation = data.initialisation;
			const protocol = data.protocol;
			const grouping = data.grouping;
			const destination = data.destination;
			const cycle = data.cycle;
			const carSpecific = data.car_specific;
			const ha_discovery = data.ha_discovery;
			const carModel = data.car_model;
			const pids = data.pids;
			const table = document.getElementById("automate_table").getElementsByTagName('tbody')[0];

			if(carSpecific != "enable"){
				document.getElementById("car_specific").value = "disable";
			}else{
				document.getElementById("car_specific").value = carSpecific;
			}
			document.getElementById("ha_discovery").value = "disable";
			if(grouping != "enable"){
				document.getElementById("grouping").value = "disable";
			}else{
				document.getElementById("grouping").value = grouping;
			}
			if(cycle === undefined){
				document.getElementById("pid_cycle").value = 5000;
			}else{
				document.getElementById("pid_cycle").value = cycle;
			}
			if(destination === undefined){
				document.getElementById("destination").value = "";
			}else{
				document.getElementById("destination").value = destination;
			}
			// Set values for the fields
			document.getElementById("initialisation").value = initialisation;
			document.getElementById("car_model").value = carModel;

			// Trigger change events to apply any dependent changes
			document.getElementById("car_specific").dispatchEvent(new Event('change'));
			document.getElementById("grouping").dispatchEvent(new Event('change'));

			// Insert rows into the table
			pids.forEach(rowData => {
				const newRow = table.insertRow();
				insertRowCells(newRow, rowData);
			});

			// Debugging: Log the values to ensure they are set correctly
			console.log("Initialisation:", initialisation);
			console.log("Protocol:", protocol);
			console.log("Grouping:", grouping);
			console.log("Destination:", destination);
			console.log("Cycle:", cycle);
			console.log("Car Specific:", carSpecific);
			console.log("Car Model:", carModel);

			// Ensure the correct state
			toggleCarModel();
			toggleDestinationAndCycle();
			toggleSendToFields();
        }

        function addRowAutoTable() {
            const table = document.getElementById("automate_table").getElementsByTagName('tbody')[0];
            const newRow = table.insertRow();
            insertRowCells(newRow, {});
            enableAutoStoreButton();
        }

        function insertRowCells(newRow, rowData) {
            const columns = [
                "Name",
                "Init",
                "PID",
                "Expression",
                "Period",
                "Type",
                "Send_to"
            ];

            columns.forEach(column => {
                const newCell = newRow.insertCell();
                if (column === "Type") {
                    const select = document.createElement("select");
                    select.name = column;
                    select.style.width = "120px";
                    const options = ["MQTT_Topic", "MQTT_WallBox"];
    
					options.forEach(optionValue => {
						const option = document.createElement("option");
						option.value = optionValue;
						option.text = optionValue;
						select.appendChild(option);
					});
					
                    if (rowData[column]) {
                        select.value = rowData[column];
                    }
                    select.addEventListener('change', enableAutoStoreButton);
                    newCell.appendChild(select);
                } else {
                    const input = document.createElement("input");

                    if (column === "Name") {
                        input.style.width = "100px";
                    } else if (column === "Init") {
                        input.style.width = "100px";
                    } else if (column === "PID") {
                        input.style.width = "60px";
                        input.addEventListener('input', checkForDuplicates);
                    } else if (column === "Period") {
                        input.style.width = "60px";
                    }

                    input.type = "text";
                    input.name = column;
                    input.value = rowData[column] || "";
                    input.addEventListener('input', enableAutoStoreButton);
                    newCell.appendChild(input);
                }
            });

            const deleteCell = newRow.insertCell();
            const deleteButton = document.createElement("button");
            deleteButton.className = "delete";
            deleteButton.innerText = "Delete";
            deleteButton.onclick = function() {
                const row = this.parentNode.parentNode;
                row.parentNode.removeChild(row);
                checkForDuplicates();
                enableAutoStoreButton();
            };
            deleteCell.appendChild(deleteButton);
        }

        function enableAutoStoreButton() {
            document.querySelector(".store").disabled = false;
        }
		
        function storeAutoTableData() {
            const initialisationValue = document.getElementById("initialisation").value;
            const groupingValue = document.getElementById("grouping").value;
			const ha_discoveryValue = document.getElementById("ha_discovery").value;
            const destinationValue = document.getElementById("destination").value;
			const cycleField = document.getElementById("pid_cycle");
            const cycleValue = document.getElementById("pid_cycle").value;
            const carSpecificValue = document.getElementById("car_specific").value;
			const carModelField = document.getElementById("car_model");
            const carModelValue = document.getElementById("car_model").value;
            const table = document.getElementById("automate_table").getElementsByTagName('tbody')[0];
            const rows = table.getElementsByTagName('tr');
            const data = [];
            const namesSet = new Set();
            
            if (!cycleField.disabled && (!/^\d+$/.test(cycleValue) || parseInt(cycleValue) < 1000)) {
                alert("Cycle must be a number greater than 1000");
                return;
            }

			if (!carModelField.disabled && carModelValue.length === 0){
                alert("Car Model must be selected");
                return;
			}

            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('input');
                const selectCells = rows[i].getElementsByTagName('select');
                const rowData = {};
                let isValid = true;

                for (let j = 0; j < cells.length; j++) {
                    const name = cells[j].name;
                    const value = cells[j].value;

                    if (name === "Name") {
                        if (value.length === 0 || value.length >= 32) {
                            alert("Name must not be empty and must be less than 32 characters");
                            isValid = false;
                            break;
                        } else if (namesSet.has(value)) {
                            alert("Name must be unique in the table");
                            isValid = false;
                            break;
                        } else {
                            namesSet.add(value);
                        }
                    } else if (name === "PID" && value.length === 0) {
                        alert("PID cannot be empty");
                        isValid = false;
                        break;
                    } else if (name === "PID" && value.length >= 10) {
                        alert("PID must be less than 10 characters");
                        isValid = false;
                        break;
                    } else if (name === "Expression" && value.length === 0) {
                        alert("Expression cannot be empty");
                        isValid = false;
                        break;
                    } else if (name === "Expression" && value.length >= 32) {
                        alert("Expression must be less than 32 characters");
                        isValid = false;
                        break;
                    } else if (name === "Period" && (!/^\d+$/.test(value) || (parseInt(value) < 100 && parseInt(value) != 0))) {
                        alert("Period must be a number greater than 100");
                        isValid = false;
                        break;
                    } else if (name === "Send_to" && value.length >= 64) {
                        alert("Send_to must be less than 64 characters");
                        isValid = false;
                        break;
                    }
                    rowData[name] = value;
                }

                for (let k = 0; k < selectCells.length; k++) {
                    const name = selectCells[k].name;
                    const value = selectCells[k].value;
                    rowData[name] = value;
                }

                if (!isValid) {
                    return;
                }

                data.push(rowData);
            }

            const jsonData = JSON.stringify({
                initialisation: initialisationValue,
                grouping: groupingValue,
                destination: destinationValue,
                cycle: cycleValue,
                car_specific: carSpecificValue,
				ha_discovery: ha_discoveryValue,
                car_model: carModelValue,
                pids: data
            });

            // Make an HTTP POST request with the jsonData
            fetch('store_auto_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: jsonData
            })
            // .then(response => response.json())
            // .then(data => {
            //     console.log('Success:', data);
            // })
            // .catch((error) => {
            //     console.error('Error:', error);
            // });

            document.querySelector(".store").disabled = true;
        }


        function checkForDuplicates() {
            const groupingValue = document.getElementById("grouping").value;
            if (groupingValue === "Group PID") {
                const table = document.getElementById("automate_table").getElementsByTagName('tbody')[0];
                const rows = table.getElementsByTagName('tr');
                const pidSet = new Set();
                for (let i = 0; i < rows.length; i++) {
                    const pidInput = rows[i].querySelector('input[name="PID"]');
                    const sendToInput = rows[i].querySelector('input[name="Send_to"]');
                    if (pidInput) {
                        const pidValue = pidInput.value;
                        if (pidSet.has(pidValue)) {
                            sendToInput.disabled = true;
                            sendToInput.value = '';
                        } else {
                            pidSet.add(pidValue);
                            sendToInput.disabled = false;
                        }
                    }
                }
            } else {
                const table = document.getElementById("automate_table").getElementsByTagName('tbody')[0];
                const rows = table.getElementsByTagName('tr');
                for (let i = 0; i < rows.length; i++) {
                    const sendToInput = rows[i].querySelector('input[name="Send_to"]');
                    sendToInput.disabled = false;
                }
            }
        }

        function toggleDestinationField() {
			const groupingValue = document.getElementById("grouping").value;
			toggleDestinationAndCycle();  // Reuse the updated function
        }

        function toggleSendToFields() {
            const groupingValue = document.getElementById("grouping").value;
            const table = document.getElementById("automate_table").getElementsByTagName('tbody')[0];
            const rows = table.getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                const sendToInput = rows[i].querySelector('input[name="Send_to"]');
                if (groupingValue === "Group ALL") {
                    sendToInput.disabled = true;
                } else {
                    sendToInput.disabled = false;
                }
            }
        }

	var canData = [];

	function restoreCANFLTRow(id, n, p, pi, s, b, e, c) {
		var canId = id;
		if(canId < 0) {
			canId = 0;
		} else if(canId > 536870912) {
			canId = 536870912;
		}
		var name = n;
		var pid = p;
		var pindex = pi;
		var startBit = s;
		var bitLength = b;
		var expression = e;
		var cycle = c;
		var table = document.getElementById("can_flt_table");
		var row = table.insertRow(-1);
		var cell1 = row.insertCell(0);
		var cell2 = row.insertCell(1);
		var cell3 = row.insertCell(2);
		var cell4 = row.insertCell(3);
		var cell5 = row.insertCell(4);
		var cell6 = row.insertCell(5);
		var cell7 = row.insertCell(6);
		var cell8 = row.insertCell(7);
		var cell9 = row.insertCell(8);
		cell1.innerHTML = canId;
		cell2.innerHTML = name;
		cell3.innerHTML = pid;
		cell4.innerHTML = pindex;
		cell5.innerHTML = startBit;
		cell6.innerHTML = bitLength;
		cell7.innerHTML = expression;
		cell8.innerHTML = cycle;
		cell9.innerHTML = '<button style="width: 70px;" onclick="deleteCANFLTRow(this)">Delete</button>';
		canData.push({
			CANID: canId,
			Name: name,
			PID: pid,
			PIDIndex: pindex,
			StartBit: startBit,
			BitLength: bitLength,
			Expression: expression,
			Cycle: cycle
		});
		document.getElementById("canId").value = "";
		document.getElementById("name").value = "";
		document.getElementById("pid").value = "";
		document.getElementById("pindex").value = "";
		document.getElementById("startBit").value = "";
		document.getElementById("bitLength").value = "";
		document.getElementById("expression").value = "";
		document.getElementById("cycle").value = "";
	}

	function openTab(evt, tabName) {
		var i, tabcontent, tablinks;
		tabcontent = document.getElementsByClassName("tabcontent");
		for(i = 0; i < tabcontent.length; i++) {
			tabcontent[i].style.display = "none";
		}
		tablinks = document.getElementsByClassName("tablinks");
		for(i = 0; i < tablinks.length; i++) {
			tablinks[i].className = tablinks[i].className.replace(" active", "");
		}
		document.getElementById(tabName).style.display = "block";
		evt.currentTarget.className += " active";
	}

	function sta_enable() {}

	function submit_enable() {
		if(document.getElementById("wifi_mode").value == "AP") {
			document.getElementById("ssid_value").disabled = true;
			document.getElementById("pass_value").disabled = true;
			document.getElementById("ble_status").disabled = false;
		} else {
			document.getElementById("ssid_value").disabled = false;
			document.getElementById("pass_value").disabled = false;
			document.getElementById("ble_status").disabled = true;
			document.getElementById("ble_status").selectedIndex = "1";
		}
		if(document.getElementById("ble_status").selectedIndex == "0") {
			alert("Warrning!\\r\\n\\r\\nWhen BLE is connected the WiFi AP WiCAN_xxxxxx will be disabled.\\r\\nTo re-ennable the WiFi AP Turn OFF BLE on your phone or device, then power cycle WiCAN. If you connect to WiFi AP ssid WiCAN_xxxxxx, the BLE will automatically be disabled.");
			document.getElementById("mqtt_en").value = "disable";
			document.getElementById("mqtt_en_div").style.display = "none";
			document.getElementById("mqtt_en").disabled = true;
			document.getElementById("batt_alert").value = "disable";
			document.getElementById("batt_alert_div").style.display = "none";
			document.getElementById("batt_alert").disabled = true;
		} else {
			document.getElementById("mqtt_en").disabled = false;
			document.getElementById("batt_alert").disabled = false;
		}
		if(document.getElementById("ap_pass_value").value.length < 8 || document.getElementById("ap_pass_value").value.length > 63 || document.getElementById("pass_value").value.length < 8 || document.getElementById("pass_value").value.length > 63) {
			document.getElementById("ret_msg").innerHTML = "AP/station password len, min=0 max=64";
			document.getElementById("ret_msg").style.color = "red";
			document.getElementById("submit_button").disabled = true;
		} else if(document.getElementById("ssid_value").value.length < 1 || document.getElementById("ssid_value").value.length > 32) {
			document.getElementById("ret_msg").innerHTML = "AP/station ssid len, min=1 max=32";
			document.getElementById("ret_msg").style.color = "red";
			document.getElementById("submit_button").disabled = true;
		} else if(document.getElementById("mqtt_tx_topic").value.length < 1 || document.getElementById("mqtt_tx_topic").value.length > 32) {
			document.getElementById("ret_msg").innerHTML = "mqtt tx topic len, min=1 max=64";
			document.getElementById("ret_msg").style.color = "red";
			document.getElementById("submit_button").disabled = true;
		}  else if(document.getElementById("mqtt_rx_topic").value.length < 1 || document.getElementById("mqtt_rx_topic").value.length > 32) {
			document.getElementById("ret_msg").innerHTML = "mqtt rx topic len, min=1 max=64";
			document.getElementById("ret_msg").style.color = "red";
			document.getElementById("submit_button").disabled = true;
		}  else if(document.getElementById("mqtt_status_topic").value.length < 1 || document.getElementById("mqtt_status_topic").value.length > 32) {
			document.getElementById("ret_msg").innerHTML = "mqtt status topic len, min=1 max=64";
			document.getElementById("ret_msg").style.color = "red";
			document.getElementById("submit_button").disabled = true;
		} else if(document.getElementById("tcp_port_value").value > 65535 || document.getElementById("tcp_port_value").value < 1) {
			document.getElementById("ret_msg").innerHTML = "Port value, min=1 max=65535";
			document.getElementById("ret_msg").style.color = "red";
			document.getElementById("submit_button").disabled = true;
		} else if(document.getElementById("batt_alert_port").value > 65535 || document.getElementById("batt_alert_port").value < 1) {
			document.getElementById("ret_msg").innerHTML = "Port value, min=1 max=65535";
			document.getElementById("ret_msg").style.color = "red";
			document.getElementById("submit_button").disabled = true;
		} else if(document.getElementById("ble_pass_value").value.length != 6 || document.getElementById("ble_pass_value").value.charAt(0) == "0") {
			document.getElementById("ret_msg").innerHTML = "Passkey length, min=6 max=6, 1st number not 0";
			document.getElementById("ret_msg").style.color = "red";
			document.getElementById("submit_button").disabled = true;
		} else if(document.getElementById("sleep_volt").value < 12 || document.getElementById("sleep_volt").value > 15) {
			document.getElementById("ret_msg").innerHTML = "Port value, min=12.0 max=15.0";
			document.getElementById("ret_msg").style.color = "red";
			document.getElementById("submit_button").disabled = true;
		} else {
			document.getElementById("submit_button").disabled = false;
			document.getElementById("ret_msg").innerHTML = " ";
		}
		if(document.getElementById("protocol").value == "savvycan") {
			document.getElementById("tcp_port_value").value = "23";
			document.getElementById("tcp_port_value").disabled = true;
			document.getElementById("port_type").selectedIndex = "0";
			document.getElementById("port_type").disabled = true;
		} else {
			document.getElementById("tcp_port_value").disabled = false;
			document.getElementById("port_type").selectedIndex = "0";
			document.getElementById("port_type").disabled = false;
		}
		if(document.getElementById("sleep_status").value == "enable") {
			if(document.getElementById("ble_status").selectedIndex != "0") {
				document.getElementById("batt_alert").disabled = false;
			}
		} else if(document.getElementById("sleep_status").value == "disable") {
			document.getElementById("batt_alert").disabled = true;
			document.getElementById("batt_alert").selectedIndex = "1";
		}
		if(document.getElementById("batt_alert").value == "enable") {
			document.getElementById("batt_alert_div").style.display = "block";
		} else if(document.getElementById("batt_alert").value == "disable") {
			document.getElementById("batt_alert_div").style.display = "none";
		}
		if(document.getElementById("mqtt_en").value == "enable") {
			document.getElementById("mqtt_en_div").style.display = "block";
		} else if(document.getElementById("mqtt_en").value == "disable") {
			document.getElementById("mqtt_en_div").style.display = "none";
		}
		if(document.getElementById("protocol").value == "elm327") {
			document.getElementById("mqtt_elm327_log").disabled = false;
		} else {
			document.getElementById("mqtt_elm327_log").disabled = true;
            document.getElementById("mqtt_elm327_log").value = "disable";
		}
	}
	document.getElementById("defaultOpen").click();

	function checkStatus() {
		const xhttp = new XMLHttpRequest();
		xhttp.onload = function() {
			var obj = JSON.parse(this.responseText);
			if(obj.wifi_mode == "APStation") {
				document.getElementById("wifi_mode_current").innerHTML = "AP+Station";
			} else if(obj.wifi_mode == "AP") {
				document.getElementById("wifi_mode_current").innerHTML = "AP";
			}
			document.getElementById("sta_status").innerHTML = obj.sta_status;
			document.getElementById("ap_channel_status").innerHTML = obj.ap_ch;
			document.getElementById("sta_ip").innerHTML = obj.sta_ip;
			document.getElementById("can_bitrate_status").innerHTML = obj.can_datarate;
			if(obj.can_mode == "normal") {
				document.getElementById("can_mode_status").innerHTML = "Normal";
			} else if(obj.can_mode == "silent") {
				document.getElementById("can_mode_status").innerHTML = "Silent";
			}
			if(obj.port_type == "tcp") {
				document.getElementById("port_type_status").innerHTML = "TCP";
			} else if(obj.port_type == "udp") {
				document.getElementById("port_type_status").innerHTML = "UDP";
			}
			document.getElementById("port_status").innerHTML = obj.port;
			document.getElementById("fw_version").innerHTML = obj.fw_version;
			document.getElementById("hw_version").innerHTML = obj.hw_version;
			document.getElementById("git_version").innerHTML = obj.git_version;
			document.getElementById("protocol").value = obj.protocol;
			document.getElementById("batt_voltage").innerHTML = obj.batt_voltage;
			document.getElementById("ret_msg").innerHTML = " ";
			if(document.getElementById("batt_alert").value == "enable") {
				document.getElementById("batt_alert_div").style.display = "block";
			} else if(document.getElementById("batt_alert").value == "disable") {
				document.getElementById("batt_alert_div").style.display = "none";
			}
			if(document.getElementById("mqtt_en").value == "enable") {
				document.getElementById("mqtt_en_div").style.display = "block";
			} else if(document.getElementById("mqtt_en").value == "disable") {
				document.getElementById("mqtt_en_div").style.display = "none";
			}
		};
		xhttp.open("GET", "/check_status");
		xhttp.send();
	}

	function loadCANFLT() {
		const xhttp = new XMLHttpRequest();
		xhttp.onload = function() {
			var obj = JSON.parse(this.responseText);
			if(this.responseText != "NONE") {
				if(Array.isArray(obj.can_flt)) {
					obj.can_flt.forEach((item) => {
						restoreCANFLTRow(item["CANID"], item["Name"], item["PID"], item["PIDIndex"], item["StartBit"], item["BitLength"], item["Expression"], item["Cycle"]);
					});
				}
			}
		};
		xhttp.open("GET", "/load_canflt");
		xhttp.send();
	}

	function loadautoPIDConfig() {
		const xhttp = new XMLHttpRequest();
		xhttp.onload = function() {
			console.log("Car models:", this.responseText);
			if(this.responseText != "NONE") {
				var obj = JSON.parse(this.responseText);
				loadCarModels(obj);
				loadautoPID();
			}else{
				toggleCarModel();
				toggleDestinationAndCycle();
				toggleSendToFields();
			}
		};
		xhttp.open("GET", "/load_auto_pid_config");
		xhttp.send();
	}

	function loadautoPID() {
		const xhttp = new XMLHttpRequest();
		xhttp.onload = function() {
			
			if(this.responseText != "NONE") {
                loadAutoTable(this.responseText);
			}
		};
		xhttp.open("GET", "/load_auto_pid");
		xhttp.send();
	}

	function postCANFLT() {
		var obj = {};
		obj["can_flt"] = canData;
		var canfltJSON = JSON.stringify(obj);
		const xhttp = new XMLHttpRequest();
		xhttp.onload = function() {
			document.getElementById("ret_msg").innerHTML = this.responseText;
			document.getElementById("ret_msg").style.color = "red";
			submit_enable();
		};
		xhttp.open("POST", "/store_canflt");
		xhttp.send(canfltJSON);
	}

	function postConfig() {
		var obj = {};
		obj["wifi_mode"] = document.getElementById("wifi_mode").value;
		obj["ap_ch"] = document.getElementById("ap_ch_value").value;
		obj["sta_ssid"] = document.getElementById("ssid_value").value;
		obj["sta_pass"] = document.getElementById("pass_value").value;
		obj["can_datarate"] = document.getElementById("can_datarate").value;
		obj["can_mode"] = document.getElementById("can_mode").value;
		obj["port_type"] = document.getElementById("port_type").value;
		obj["port"] = document.getElementById("tcp_port_value").value;
		obj["ap_pass"] = document.getElementById("ap_pass_value").value;
		obj["protocol"] = document.getElementById("protocol").value;
		obj["ble_pass"] = document.getElementById("ble_pass_value").value;
		obj["ble_status"] = document.getElementById("ble_status").value;
		obj["sleep_status"] = document.getElementById("sleep_status").value;
		obj["sleep_volt"] = document.getElementById("sleep_volt").value;
		obj["batt_alert"] = document.getElementById("batt_alert").value;
		obj["batt_alert_ssid"] = document.getElementById("batt_alert_ssid").value;
		obj["batt_alert_pass"] = document.getElementById("batt_alert_pass").value;
		obj["batt_alert_volt"] = document.getElementById("batt_alert_volt").value;
		obj["batt_alert_protocol"] = document.getElementById("batt_alert_protocol").value;
		let mqtt_txt = "mqtt://";
		let mqtt_url_val = mqtt_txt.concat(document.getElementById("batt_alert_url").value);
		obj["batt_alert_url"] = mqtt_url_val;
		obj["batt_alert_port"] = document.getElementById("batt_alert_port").value;
		obj["batt_alert_topic"] = document.getElementById("batt_alert_topic").value;
		obj["batt_alert_time"] = document.getElementById("batt_alert_time").value;
		obj["batt_mqtt_user"] = document.getElementById("batt_mqtt_user").value;
		obj["batt_mqtt_pass"] = document.getElementById("batt_mqtt_pass").value;
		obj["mqtt_en"] = document.getElementById("mqtt_en").value;
		let mqtt_txt2 = "mqtt://";
		let mqtt_url_val2 = mqtt_txt.concat(document.getElementById("mqtt_url").value);
		obj["mqtt_url"] = mqtt_url_val2;
		obj["mqtt_port"] = document.getElementById("mqtt_port").value;
		obj["mqtt_user"] = document.getElementById("mqtt_user").value;
		obj["mqtt_pass"] = document.getElementById("mqtt_pass").value;
		obj["mqtt_tx_topic"] = document.getElementById("mqtt_tx_topic").value;
		if(document.getElementById("mqtt_tx_en_checkbox").checked){
			obj["mqtt_tx_en"] = "enable";
		}else{
			obj["mqtt_tx_en"] = "disable";
		}
		obj["mqtt_rx_topic"] = document.getElementById("mqtt_rx_topic").value;
		obj["mqtt_status_topic"] = document.getElementById("mqtt_status_topic").value;
		obj["mqtt_elm327_log"] = document.getElementById("mqtt_elm327_log").value;
		var configJSON = JSON.stringify(obj);
		const xhttp = new XMLHttpRequest();
		xhttp.onload = function() {
			document.getElementById("ret_msg").innerHTML = this.responseText;
			document.getElementById("ret_msg").style.color = "red";
		};
		xhttp.open("POST", "/store_config");
		xhttp.send(configJSON);
	}

	function otaClick() {
		if(document.getElementById("ota_file").files.length == 0) {
			document.getElementById("ret_msg").style.color = "red";
			document.getElementById("ret_msg").innerHTML = "No files selected!";
			alert("No files selected!");
		} else {
			document.getElementById("ota_submit_button").disabled = true;
			document.getElementById("ret_msg").style.color = "red";
			document.getElementById("ret_msg").innerHTML = "Updating please wait...";
			setTimeout(function() {
				document.getElementById("ota_form").submit();
			}, 5000);
		}
	}

	function reboot() {
		const xhttp = new XMLHttpRequest();
		document.getElementById("reboot_button").disabled = true;
		document.getElementById("ret_msg").style.color = "red";
		document.getElementById("ret_msg").innerHTML = "Rebooting please reconnect...";
		xhttp.open("POST", "/system_reboot");
		xhttp.send("reboot");
	}

	function Load() {
		const xhttp = new XMLHttpRequest();
		xhttp.onload = function() {
			var obj = JSON.parse(this.responseText);
			if(obj.wifi_mode == "APStation") {
				document.getElementById("wifi_mode").selectedIndex = "1";
				document.getElementById("ssid_value").disabled = false;
				document.getElementById("pass_value").disabled = false;
			} else if(obj.wifi_mode == "AP") {
				document.getElementById("wifi_mode").selectedIndex = "0";
				document.getElementById("ssid_value").disabled = true;
				document.getElementById("pass_value").disabled = true;
			}
			var ch = parseInt(obj.ap_ch);
			ch = ch - 1;
			document.getElementById("ap_ch_value").selectedIndex = ch.toString();
			document.getElementById("ssid_value").value = obj.sta_ssid;
			document.getElementById("pass_value").value = obj.sta_pass;
			if(obj.can_datarate == "5K") {
				document.getElementById("can_datarate").selectedIndex = "0";
			} else if(obj.can_datarate == "10K") {
				document.getElementById("can_datarate").selectedIndex = "1";
			} else if(obj.can_datarate == "20K") {
				document.getElementById("can_datarate").selectedIndex = "2";
			} else if(obj.can_datarate == "25K") {
				document.getElementById("can_datarate").selectedIndex = "3";
			} else if(obj.can_datarate == "50K") {
				document.getElementById("can_datarate").selectedIndex = "4";
			} else if(obj.can_datarate == "100K") {
				document.getElementById("can_datarate").selectedIndex = "5";
			} else if(obj.can_datarate == "125K") {
				document.getElementById("can_datarate").selectedIndex = "6";
			} else if(obj.can_datarate == "250K") {
				document.getElementById("can_datarate").selectedIndex = "7";
			} else if(obj.can_datarate == "500K") {
				document.getElementById("can_datarate").selectedIndex = "8";
			} else if(obj.can_datarate == "800K") {
				document.getElementById("can_datarate").selectedIndex = "9";
			} else if(obj.can_datarate == "1000K") {
				document.getElementById("can_datarate").selectedIndex = "10";
			} else if(obj.can_datarate == "auto") {
				document.getElementById("can_datarate").selectedIndex = "11";
			}
			if(obj.can_mode == "normal") {
				document.getElementById("can_mode").selectedIndex = "0";
			} else if(obj.can_mode == "silent") {
				document.getElementById("can_mode").selectedIndex = "1";
			}
			if(obj.port_type == "tcp") {
				document.getElementById("port_type").selectedIndex = "0";
			} else if(obj.port_type == "udp") {
				document.getElementById("port_type").selectedIndex = "1";
			}
			if(obj.ble_status == "enable") {
				document.getElementById("ble_status").selectedIndex = "0";
			} else if(obj.ble_status == "disable") {
				document.getElementById("ble_status").selectedIndex = "1";
			}
			if(obj.sleep_status == "enable") {
				document.getElementById("sleep_status").selectedIndex = "0";
			} else if(obj.sleep_status == "disable") {
				document.getElementById("sleep_status").selectedIndex = "1";
			}

			if ("mqtt_tx_en" in obj) {
				if (obj.mqtt_tx_en === "enable") {
					document.getElementById("mqtt_tx_en_checkbox").checked = true;
				} else {
					document.getElementById("mqtt_tx_en_checkbox").checked = false;
				}
			} else {
				document.getElementById("mqtt_tx_en_checkbox").checked = false; 
			}
			
			txCheckBoxChanged();
			document.getElementById("protocol").value = obj.protocol;
			document.getElementById("tcp_port_value").value = obj.port;
			document.getElementById("ap_pass_value").value = obj.ap_pass;
			document.getElementById("ble_pass_value").value = obj.ble_pass;
			document.getElementById("sleep_volt").value = obj.sleep_volt;
			document.getElementById("batt_alert").value = obj.batt_alert;
			document.getElementById("batt_alert_ssid").value = obj.batt_alert_ssid;
			document.getElementById("batt_alert_pass").value = obj.batt_alert_pass;
			document.getElementById("batt_alert_volt").value = obj.batt_alert_volt;
			document.getElementById("batt_alert_protocol").value = obj.batt_alert_protocol;
			document.getElementById("batt_alert_url").value = obj.batt_alert_url.slice(7);
			document.getElementById("batt_alert_port").value = obj.batt_alert_port;
			document.getElementById("batt_alert_topic").value = obj.batt_alert_topic;
			document.getElementById("batt_mqtt_user").value = obj.batt_mqtt_user;
			document.getElementById("batt_mqtt_pass").value = obj.batt_mqtt_pass;
			document.getElementById("mqtt_en").value = obj.mqtt_en;
			document.getElementById("mqtt_url").value = obj.mqtt_url.slice(7);
			document.getElementById("mqtt_port").value = obj.mqtt_port;
			document.getElementById("mqtt_user").value = obj.mqtt_user;
			document.getElementById("mqtt_pass").value = obj.mqtt_pass;
			document.getElementById("mqtt_tx_topic").value = obj.mqtt_tx_topic;
			document.getElementById("mqtt_rx_topic").value = obj.mqtt_rx_topic;
			document.getElementById("mqtt_status_topic").value = obj.mqtt_status_topic;
			document.getElementById("mqtt_elm327_log").value = obj.mqtt_elm327_log;
			if(obj.batt_alert_time == "1") {
				document.getElementById("batt_alert_time").selectedIndex = "0";
			} else if(obj.batt_alert_time == "6") {
				document.getElementById("batt_alert_time").selectedIndex = "1";
			} else if(obj.batt_alert_time == "12") {
				document.getElementById("batt_alert_time").selectedIndex = "2";
			} else if(obj.batt_alert_time == "24") {
				document.getElementById("batt_alert_time").selectedIndex = "3";
			}
			if(document.getElementById("protocol").value == "savvycan") {
				document.getElementById("tcp_port_value").value = "23";
				document.getElementById("tcp_port_value").disabled = true;
				document.getElementById("port_type").selectedIndex = "0";
				document.getElementById("port_type").disabled = true;
			}
			if(document.getElementById("batt_alert").value == "enable") {
				document.getElementById("batt_alert_div").style.display = "block";
			} else if(document.getElementById("batt_alert").value == "disable") {
				document.getElementById("batt_alert_div").style.display = "none";
			}
			if(document.getElementById("mqtt_en").value == "enable") {
				document.getElementById("mqtt_en_div").style.display = "block";
			} else if(document.getElementById("mqtt_en").value == "disable") {
				document.getElementById("mqtt_en_div").style.display = "none";
			}
			document.getElementById("ret_msg").innerHTML = " ";
			loadCANFLT();
			loadautoPIDConfig();
			document.getElementById("store_canflt_button").disabled = true;
			document.querySelector(".store").disabled = true;
		};
		checkStatus();
		xhttp.open("GET", "/load_config");
		xhttp.send();
	}

	function monitor_add_line(id, type, len, data, time) {
		var table = document.getElementById("table2");
		var nraw = -1;
		if(typeof monitor_add_line.msg_time == "undefined") {
			monitor_add_line.msg_time = [0];
		}
		for(var r = 1, n = table.rows.length; r < n; r++) {
			if(table.rows[r].cells[0].innerHTML == id) {
				nraw = r;
				break;
			}
		}
		if(nraw != -1) {
			table.rows[nraw].cells[0].innerHTML = id;
			table.rows[nraw].cells[1].innerHTML = type;
			table.rows[nraw].cells[2].innerHTML = len;
			table.rows[nraw].cells[3].innerHTML = data;
			table.rows[nraw].cells[4].innerHTML = Date.now() - monitor_add_line.msg_time[nraw];
			table.rows[nraw].cells[5].innerHTML = ++table.rows[nraw].cells[5].innerHTML;
			monitor_add_line.msg_time[nraw] = Date.now();
		} else {
			var row = table.insertRow(1);
			var cell1 = row.insertCell(0);
			var cell2 = row.insertCell(1);
			var cell3 = row.insertCell(2);
			var cell4 = row.insertCell(3);
			var cell5 = row.insertCell(4);
			var cell6 = row.insertCell(5);
			cell1.innerHTML = id;
			cell2.innerHTML = type;
			cell3.innerHTML = len;
			cell4.innerHTML = data;
			cell5.innerHTML = 0;
			cell6.innerHTML = 1;
			monitor_add_line.msg_time.push(Date.now());
		}
	}
	var ws = null;
	var cr = String.fromCharCode(13);

	function mon_control() {
		var dr = document.getElementById("mon_datarate").selectedIndex;
		var url = window.location.href;
		var url2 = "http://192.168.31.72/";
		console.log(dr);
		alert("Please reboot device after Monitor, otherwise the device may not function as expected");
		ws_url = "ws://" + url.substr(7, url.length) + "ws";
		console.log(ws_url);
		if(document.getElementById("mon_button").value == "Start") {
			ws = new WebSocket(ws_url);
			setTimeout(bindEvents, 1000);
			ws.addEventListener("open", (event) => {
				var cmd = "C" + cr + "S" + dr + cr + "O" + cr;
				console.log("onopen called");
				ws.send(cmd);
				window.mon_button_en(0);
			});
			ws.addEventListener("close", (event) => {
				window.mon_button_en(1);
				console.log("onclose called");
			});
		} else {
			ws_close();
		}
	}

	function bindEvents() {
		ws.onmessage = function(evt) {
			var received_msg = evt.data;
			if(received_msg[0] == "t") {
				var len = (received_msg[4] - "0") * 2;
				var data_str = "";
				var i;
				for(i = 0; i < len; i += 2) {
					data_str += received_msg.substr(i + 5, 2) + " ";
				}
				monitor_add_line(received_msg.substr(1, 3) + "h", "Std", received_msg[4], data_str, 0);
			} else if(received_msg[0] == "T") {
				var len = (received_msg[9] - "0") * 2;
				var data_str = "";
				var i;
				for(i = 0; i < len; i += 2) {
					data_str += received_msg.substr(i + 10, 2) + " ";
				}
				monitor_add_line(received_msg.substr(1, 8) + "h", "Ext", received_msg[9], data_str, 0);
			} else if(received_msg[0] == "r") {
				var len = (received_msg[4] - "0") * 2;
				monitor_add_line(received_msg.substr(1, 3) + "h", "RTR-Std", received_msg[4], 0, 0);
			} else if(received_msg[0] == "R") {
				var len = (received_msg[9] - "0") * 2;
				monitor_add_line(received_msg.substr(1, 8) + "h", "RTR-Ext", received_msg[9], 0, 0);
			}
		};
	}

	function ws_close() {
		ws.send("C" + cr);
		ws.close();
	}

	function mon_button_en(b) {
		if(b == 1) {
			document.getElementById("mon_button").value = "Start";
			document.getElementById("mon_datarate").disabled = false;
			document.getElementById("mon_filter").disabled = false;
			document.getElementById("mon_mask").disabled = false;
		} else {
			document.getElementById("mon_button").value = "Stop";
			document.getElementById("mon_datarate").disabled = true;
			document.getElementById("mon_filter").disabled = true;
			document.getElementById("mon_mask").disabled = true;
		}
	}

	function isNameUnique(name) {
		return canData.every((item) => item["Name"] !== name);
	}

	function addCANFLTRow() {
		var canId = parseInt(document.getElementById("canId").value);
		var startBit = parseInt(document.getElementById("startBit").value);
		var bitLength = parseInt(document.getElementById("bitLength").value);
		Length = parseInt(document.getElementById("bitLength").value);
		var cycle = parseInt(document.getElementById("cycle").value);
		var name = document.getElementById("name").value;
		var expression = document.getElementById("expression").value;
		var pid = parseInt(document.getElementById("pid").value);
		var pidi = parseInt(document.getElementById("pindex").value);
		if(isNaN(canId) || canId == "" || canId < 0 || canId > 536870912) {
			alert("CAN ID must be a valid number between 0 and 536870912");
			return;
		}
		if(isNaN(startBit) || isNaN(bitLength) || startBit > 64 - bitLength || bitLength <= 0 || bitLength > 64 || startBit < 0 || startBit > 63) {
			alert("startBit or bitLength error");
			return;
		}
		if(isNaN(cycle) || cycle < 100 || cycle > 10000) {
			alert("cycle must be between 100 and 10000");
			return;
		}
		if(name.length < 1 || name.length > 16) {
			alert("Name must be between 1 and 16 characters in length.");
			return;
		}
		if(expression.length < 1 || expression.length > 32) {
			alert("Expression must be between 1 and 32 characters in length.");
			return;
		}
		if(isNaN(pid) || pid < -1 || pid > 255) {
			alert("PID must be a number between -1 and 255");
			return;
		}
		if(isNaN(pidi) || pidi < 0 || pidi > 7) {
			alert("PID must be a number between 0 and 7");
			return;
		}
		if(isNameUnique(name)) {
			var table = document.getElementById("can_flt_table");
			var row = table.insertRow(-1);
			var cell1 = row.insertCell(0);
			var cell2 = row.insertCell(1);
			var cell3 = row.insertCell(2);
			var cell4 = row.insertCell(3);
			var cell5 = row.insertCell(4);
			var cell6 = row.insertCell(5);
			var cell7 = row.insertCell(6);
			var cell8 = row.insertCell(7);
			var cell9 = row.insertCell(8);
			if(table.rows.length - 1 >= 100) {
				alert("Maximum row limit (100) reached.");
				return;
			}
			cell1.innerHTML = canId;
			cell2.innerHTML = name;
			cell3.innerHTML = pid;
			cell4.innerHTML = pidi;
			cell5.innerHTML = startBit;
			cell6.innerHTML = bitLength;
			cell7.innerHTML = expression;
			cell8.innerHTML = cycle;
			cell9.innerHTML = '<button style="width: 70px;" onclick="deleteCANFLTRow(this) ">Delete</button>';
			canData.push({
				CANID: canId,
				Name: name,
				PID: pid,
				PIDIndex: pidi,
				StartBit: startBit,
				BitLength: bitLength,
				Expression: expression,
				Cycle: cycle
			});
			document.getElementById("canId").value = "";
			document.getElementById("name").value = "";
			document.getElementById("pid").value = "";
			document.getElementById("pindex").value = "";
			document.getElementById("startBit").value = "";
			document.getElementById("bitLength").value = "";
			document.getElementById("expression").value = "";
			document.getElementById("cycle").value = "";
		} else {
			alert("Name must be unique.");
		}
		document.getElementById("store_canflt_button").disabled = false;
	}

	function deleteCANFLTRow(button) {
		var row = button.parentNode.parentNode;
		var canIdToDelete = row.cells[0].textContent;
		var indexToDelete = canData.findIndex((item) => item["CANID"] === parseInt(canIdToDelete));
		if(indexToDelete !== -1) {
			canData.splice(indexToDelete, 1);
		}
		row.parentNode.removeChild(row);
		document.getElementById("store_canflt_button").disabled = false;
	}

	function alert_elm327() {
		alert("If elm327 log is enabled then only CAN frames proccessed by elm327 will be sent to MQTT broker.");
	}

	function storeCANFLT() {
		postCANFLT();
		document.getElementById("store_canflt_button").disabled = true;
	}
	</script>
</body>

</html>